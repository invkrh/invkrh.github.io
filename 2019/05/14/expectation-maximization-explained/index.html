<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">










  <meta name="google-site-verification" content="jR_bUEN846roQfh9C1VWdQ9eb9YaT7E_G142mMBeqow">












  
  
  
  

  
    
    
  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link rel="stylesheet" referrerpolicy="no-referrer" type="text/css" href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Lato:300,300italic,400,400italic,700,700italic|Raleway:300,300italic,400,400italic,700,700italic|Parisienne:300,300italic,400,400italic,700,700italic|Consolas:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext">
  






<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon-next.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png?v=7.1.0">


  <link rel="mask-icon" href="/icons/safari-pinned-tab.svg?v=7.1.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="The EM algorithm is used to find (local) maximum likelihood parameters of a statistical model in cases where the equations cannot be solved directly. Typically these models involve latent variables in">
<meta name="keywords" content="Maths">
<meta property="og:type" content="article">
<meta property="og:title" content="Expectation-Maximization Algorithm Explained">
<meta property="og:url" content="http://invkrh.me/2019/05/14/expectation-maximization-explained/index.html">
<meta property="og:site_name" content="Yorozuya">
<meta property="og:description" content="The EM algorithm is used to find (local) maximum likelihood parameters of a statistical model in cases where the equations cannot be solved directly. Typically these models involve latent variables in">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-06-09T23:36:51.523Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Expectation-Maximization Algorithm Explained">
<meta name="twitter:description" content="The EM algorithm is used to find (local) maximum likelihood parameters of a statistical model in cases where the equations cannot be solved directly. Typically these models involve latent variables in">



  <link rel="alternate" href="/atom.xml" title="Yorozuya" type="application/atom+xml">



  
  
  <link rel="canonical" href="http://invkrh.me/2019/05/14/expectation-maximization-explained/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Expectation-Maximization Algorithm Explained | Yorozuya</title>
  




  <script async src="//www.googletagmanager.com/gtag/js?id=UA-74632317-1"></script>
  <script>
    var host = window.location.hostname;
    if (host !== "localhost" || !true) {
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-74632317-1');
    }
  </script>









  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>


  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


  <link rel="stylesheet" href="/css/prism.css">
  <link rel="stylesheet" href="/css/mathjax-md.css">
</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Yorozuya</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://invkrh.me/2019/05/14/expectation-maximization-explained/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Hao Ren">
      <meta itemprop="description" content="Machine Learning Engineer @ Criteo">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yorozuya">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Expectation-Maximization Algorithm Explained

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-05-14 23:49:26" itemprop="dateCreated datePublished" datetime="2019-05-14T23:49:26+02:00">2019-05-14</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Machine-Learning/" itemprop="url" rel="index"><span itemprop="name">Machine Learning</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/2019/05/14/expectation-maximization-explained/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/05/14/expectation-maximization-explained/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>The EM algorithm is used to find (local) maximum likelihood parameters of a statistical model in cases where the equations cannot be solved directly. Typically these models involve latent variables in addition to unknown parameters and known data observations. In this post, we will start with how the algorithm works and then prove its correctness, finally we will show a concrete yet the most common use case where the algorithm is applied.</p>
<a id="more"></a>
<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>The typical setting of the EM algorithm is a parameter estimation problem in which we have </p>
<ul>
<li>A training set <script type="math/tex">\mathbf{X} = \{ x_1, \ldots, x_n \}</script> consisting of $n$ independent observed data points. Each may be discrete or continuous. Associated with each data point <strong>may be</strong> a vector of observations <script type="math/tex">\mathbf{Y} = \{ y_1, \ldots, y_n \}</script>.</li>
<li>A set of <strong>unobserved</strong> latent data or missing values <script type="math/tex">\mathbf{Z} = \{ z_1, \ldots, z_n \}</script> associated with each data point. They are discrete, drawn from a fixed number of values, and with one latent variable per observed unit.</li>
<li>A vector of unknown parameters <script type="math/tex">\boldsymbol{\theta}</script> which are continuous, and are of two kinds: <ul>
<li>Parameters that are associated with all data points</li>
<li>Those associated with a specific value of a latent variable (i.e., associated with all data points which corresponding latent variable has that value).</li>
</ul>
</li>
</ul>
<p>We wish to fit the parameters of a model $p(x ; \boldsymbol{\theta})$ (may or may not include $y$) and the log <a href="https://en.wikipedia.org/wiki/Marginal_distribution" target="_blank" rel="noopener">marginal likelihood</a> function of all data points to maximize is given by</p>
<script type="math/tex; mode=display">
\begin{aligned}
    L(\boldsymbol{\theta};\mathbf{X}) &=\sum_{i=1}^{n} \log p(x_i ; \boldsymbol{\theta}) \\
    &=\sum_{i=1}^{n} \log \sum_{z_i} p(x_i, z_i ; \boldsymbol{\theta})
\end{aligned}</script><p>However, maximizing <script type="math/tex">L(\boldsymbol{\theta};\mathbf{X})</script> explicityly might be difficult because <script type="math/tex">\mathbf{Z}</script> are the latent random variables. The good thing of EM is not to maximizing the log likelihood directly, but instead, it leverages the following (we will see later):</p>
<script type="math/tex; mode=display">
L(\boldsymbol{\theta}; \mathbf{X}, \mathbf{Z}) = \sum_{i=1}^{n} \log p(x_i, z_i ; \boldsymbol{\theta})</script><p>The EM algorithm seeks to find the MLE of the marginal likelihood by iteratively applying these two steps:</p>
<ul>
<li><p>Expectation step (E step): Define <script type="math/tex">Q(\boldsymbol{\theta} \mid \boldsymbol{\theta}^{(t)})</script> as the expected value of the log likelihood function of <script type="math/tex">\boldsymbol{\theta}</script>, with respect to the current conditional distribution of <script type="math/tex">\mathbf{Z}</script>,  given <script type="math/tex">\mathbf{X}</script> and the current estimates of the parameters <script type="math/tex">\boldsymbol{\theta}^{(t)}</script></p>
<script type="math/tex; mode=display">
\begin{aligned}
  Q(\boldsymbol{\theta} \mid \boldsymbol{\theta}^{(t)}) &= \mathrm{E}_{z \mid x; \boldsymbol{\theta}^{(t)}} \left [ L(\boldsymbol{\theta}; \mathbf{X}, \mathbf{Z}) \right ] \\
  &= \mathrm{E}_{z \mid x; \boldsymbol{\theta}^{(t)}} \left [ \sum_{i=1}^{n} \log p(x_i, z_i ; \boldsymbol{\theta}) \right ] \\
  &= \sum_{i=1}^{n} \mathrm{E}_{z_i \mid x_i; \boldsymbol{\theta}^{(t)}} \left [ \log p(x_i, z_i ; \boldsymbol{\theta}) \right ] \\
  &= \sum_{i=1}^{n} \sum_{z_i} p(z_i \mid x_i; \boldsymbol{\theta}^{(t)}) \log p(x_i, z_i ; \boldsymbol{\theta})
\end{aligned}</script></li>
<li><p>Maximization step (M step): Find the parameters that maximize this quantity:</p>
<script type="math/tex; mode=display">
\boldsymbol{\theta}^{(t+1)} = \underset{\boldsymbol{\theta}}{\arg \max} \, Q\left(\boldsymbol{\theta} \mid \boldsymbol{\theta}^{(t)}\right)</script></li>
</ul>
<h1 id="Proof-of-correctness"><a href="#Proof-of-correctness" class="headerlink" title="Proof of correctness"></a>Proof of correctness</h1><p>The trick of EM algorithm is to improve <script type="math/tex">Q(\boldsymbol{\theta} \mid \boldsymbol{\theta}^{(t)})</script> rather than directly improving <script type="math/tex">L(\boldsymbol{\theta})</script>. Here is shown that improvements to the former imply improvements to the latter.</p>
<p>For any $z_i$ with non-zero probability $p(z_i \mid x_i; \boldsymbol{\theta})$, we can write the following (based on Bayes’ theorem)</p>
<script type="math/tex; mode=display">
\log p(x_i ; \boldsymbol{\theta})=\log p(x_i, z_i ; \boldsymbol{\theta})-\log p(z_i \mid x_i; \boldsymbol{\theta})</script><p>We take the expectation over possible values of the unknown data $z_i$ under the current parameter estimate $\boldsymbol{\theta}^{(t)}$ by multiplying both sides by $p(z_i \mid x_i; \boldsymbol{\theta}^{(t)})$ and summing (or integrating) over $z$ . The left-hand side is the expectation of a constant, so we get:</p>
<script type="math/tex; mode=display">
\begin{aligned}
\log p(x_i ; \boldsymbol{\theta}) &= \sum_{z_i} p \left( z_i \mid x_i; \boldsymbol{\theta}^{(t)} \right) \log p(x_i, z_i ; \boldsymbol{\theta}) - \sum_{z_i} p \left( z_i \mid x_i; \boldsymbol{\theta}^{(t)} \right) \log p(z_i \mid x_i ; \boldsymbol{\theta}) \\ 
& = G_i \left( \boldsymbol{\theta} \mid \boldsymbol{\theta}^{(t)} \right) + H_i \left( \boldsymbol{\theta} \mid \boldsymbol{\theta}^{(t)} \right)
\end{aligned}</script><p>where <script type="math/tex">H_i \left(\boldsymbol{\theta} \mid \boldsymbol{\theta}^{(t)}\right)</script> is defined by the negated sum it is replacing and <script type="math/tex">Q(\cdot) = \sum_{i=1}^{n} G_i(\cdot)</script>.<br>This last equation holds for every value of $\boldsymbol{\theta}$ including <script type="math/tex">\boldsymbol{\theta} = \boldsymbol{\theta}^{(t)}</script>,</p>
<script type="math/tex; mode=display">
\log p\left(x_i \mid \boldsymbol{\theta}^{(t)} \right) = G_i \left( \boldsymbol{\theta}^{(t)} \mid \boldsymbol{\theta}^{(t)} \right) + H_i \left( \boldsymbol{\theta}^{(t)} \mid \boldsymbol{\theta}^{(t)} \right)</script><p>and subtracting this last equation from the previous equation gives</p>
<script type="math/tex; mode=display">
\log p(x_i ; \boldsymbol{\theta}) - \log p\left( x_i ; \boldsymbol{\theta}^{(t)} \right) = G_i \left( \boldsymbol{\theta} \mid \boldsymbol{\theta}^{(t)} \right) - G_i \left( \boldsymbol{\theta}^{(t)} \mid \boldsymbol{\theta}^{(t)} \right) + H_i \left( \boldsymbol{\theta} \mid \boldsymbol{\theta}^{(t)} \right) - H_i \left( \boldsymbol{\theta}^{(t)} \mid \boldsymbol{\theta}^{(t)} \right)</script><p>Note that</p>
<ul>
<li><script type="math/tex">H_i\left(\boldsymbol{\theta} \mid \boldsymbol{\theta}^{(t)} \right)</script> is exactly the cross entropy of the distribution $z_i \mid x_i; \boldsymbol{\theta}^{(t)}$ with the other distribution $z_i \mid x_i; \boldsymbol{\theta}$</li>
<li><script type="math/tex">H_i\left(\boldsymbol{\theta}^{(t)} \mid \boldsymbol{\theta}^{(t)} \right)</script> is exactly the entropy of the distribution of $z_i \mid x_i; \boldsymbol{\theta}^{(t)}$</li>
</ul>
<p>Based on <a href="https://en.wikipedia.org/wiki/Gibbs%27_inequality" target="_blank" rel="noopener">Gibbs’ inequality</a>: the information entropy of a distribution P is less than or equal to its cross entropy with any other distribution Q, which means</p>
<script type="math/tex; mode=display">
H_i\left(\boldsymbol{\theta} \mid \boldsymbol{\theta}^{(t)} \right) \geq H_i\left(\boldsymbol{\theta}^{(t)} \mid \boldsymbol{\theta}^{(t)} \right)</script><p>Hence, we can conclude that</p>
<script type="math/tex; mode=display">
\log p(x_i ; \boldsymbol{\theta}) - \log p\left( x_i ; \boldsymbol{\theta}^{(t)} \right) \geq G_i \left( \boldsymbol{\theta} \mid \boldsymbol{\theta}^{(t)} \right) - G_i \left( \boldsymbol{\theta}^{(t)} \mid \boldsymbol{\theta}^{(t)} \right)</script><p>By summation of all the data point</p>
<script type="math/tex; mode=display">
\sum_{i=1}^{n} \log p(x_i ; \boldsymbol{\theta}) - \sum_{i=1}^{n} \log p\left( x_i ; \boldsymbol{\theta}^{(t)} \right)
\geq 
\sum_{i=1}^{n} G_i \left( \boldsymbol{\theta} \mid \boldsymbol{\theta}^{(t)} \right) - \sum_{i=1}^{n} G_i \left( \boldsymbol{\theta}^{(t)} \mid \boldsymbol{\theta}^{(t)} \right)</script><p>which is equivalent to</p>
<script type="math/tex; mode=display">
L(\boldsymbol{\theta}) - L\left(\boldsymbol{\theta}^{(t)}\right) 
\geq 
Q \left( \boldsymbol{\theta} \mid \boldsymbol{\theta}^{(t)} \right) - Q \left( \boldsymbol{\theta}^{(t)} \mid \boldsymbol{\theta}^{(t)} \right)</script><p>In words, choosing $\boldsymbol{\theta}$ to improve $Q(\boldsymbol{\theta} \mid \boldsymbol{\theta}^{(t)})$ causes $L(\boldsymbol{\theta})$ to improve at least as much.</p>
<p>According to this <a href="./em.pdf">note</a>, you can also prove this by using <a href="https://en.wikipedia.org/wiki/Jensen%27s_inequality" target="_blank" rel="noopener">Jensen’s equality</a></p>
<h1 id="Gaussian-Mixture-Model-GMM"><a href="#Gaussian-Mixture-Model-GMM" class="headerlink" title="Gaussian Mixture Model (GMM)"></a>Gaussian Mixture Model (GMM)</h1><h2 id="Settings"><a href="#Settings" class="headerlink" title="Settings"></a>Settings</h2><p>A typical application of EM algorithm is the gaussian mixture model (GMM) which is a clustering problem as the following:</p>
<ul>
<li>A training set <script type="math/tex">\mathbf{X} = \{ x_1, \ldots, x_n \}</script> which is a sample of $n$ independent observations from a mixture of $k$ multivariate normal distributions of dimension $d$. (since we are in the unsupervised learning setting, these points do not come with any labels.)</li>
<li>Associated with the latent variables <script type="math/tex">\mathbf{Z} = \{ z_1,z_2,\ldots,z_n \}</script> that determine the component from which the observation originates. <script type="math/tex">z_i \sim \text { Multinomial }(\phi)</script> where <script type="math/tex">\phi_j \geq 0, \sum_{j=1}^{k} \phi_j=1</script> and the parameter <script type="math/tex">\phi_j</script> gives <script type="math/tex">p(z_i=j)</script>.</li>
<li>The model posits that each <script type="math/tex">x_i</script> was generated by randomly choosing <script type="math/tex">z_i</script> from <script type="math/tex">{1, \ldots, k}</script>, and then <script type="math/tex">x_i</script> was drawn from one of <script type="math/tex">k</script> Gaussians depending on <script type="math/tex">z_i</script>. Then, <script type="math/tex">x_i | z_i=j \sim \mathcal{N}\left(\mu_{j}, \Sigma_{j}\right)</script></li>
<li>The parameters to estimate <script type="math/tex">\boldsymbol{\theta} = \{\phi_j, \mu_j, \Sigma_j | j \in 1,\ldots,k\}</script>. For simplicity, <script type="math/tex">\theta_j = {\phi_j, \mu_j, \Sigma_j}</script></li>
</ul>
<p>And we wish to model the data by specifying the joint distribution <script type="math/tex">p(x_i, z_i)</script>. Hence, the log likelihood is</p>
<script type="math/tex; mode=display">
\begin{aligned}
L(\boldsymbol{\theta} ; \mathbf{X})
&= \sum_{i=1}^{n} \log \sum_{j=1}^{k} p(x_i, z_i = j; \theta_j) \\
&= \sum_{i=1}^{n} \log \sum_{j=1}^{k} p(x_i \mid z_i = j; \mu_j, \Sigma_j) \cdot p(z_i = j; \phi_j) \\
&= \sum_{i=1}^{n} \log \sum_{j=1}^{k} f\left(x_i ; \mu_j, \Sigma_j\right) \cdot \phi_j
\end{aligned}</script><p>However, if we set to zero the derivatives of this formula with respect to the parameters and try to solve, we’ll find that it is not possible to find the maximum likelihood estimates of the parameters in closed form. (Try this yourself at home.) This is where the EM algorithm comes in. </p>
<h2 id="E-step"><a href="#E-step" class="headerlink" title="E-step"></a>E-step</h2><script type="math/tex; mode=display">
L(\theta ; \mathbf{X}, \mathbf{Z}) = \sum_{i=1}^{n} \log f\left(x_i ; \mu_j, \Sigma_j\right) \cdot \phi_{j}</script><p>where</p>
<script type="math/tex; mode=display">
f\left(x_i ; \mu_j, \Sigma_j\right) = \frac{1}{(2 \pi)^{d / 2}\left|\Sigma_{j}\right|^{1 / 2}} \exp \left(-\frac{1}{2}\left(x_i-\mu_{j}\right)^{T} \Sigma_{j}^{-1}\left(x_i-\mu_{j}\right)\right)</script><script type="math/tex; mode=display">
Q(\boldsymbol{\theta} \mid \boldsymbol{\theta}^{(t)}) = \sum_{i=1}^{n} \sum_{j=1}^{k} p(z_i = j \mid x_i; \boldsymbol{\theta}^{(t)}) \cdot \log f\left(x_i ; \mu_j, \Sigma_j\right) \cdot \phi_j</script><p>Given our current estimate of the parameters <script type="math/tex">\theta^{(t)}</script>, the conditional distribution of the <script type="math/tex">z_i</script> is determined by Bayes theorem to be normalized Gaussian density weighted by <script type="math/tex">\phi_j</script>:</p>
<script type="math/tex; mode=display">
\begin{aligned}
p(z_i = j \mid x_i; \boldsymbol{\theta}^{(t)}) 
&= \frac{p(x_i, z_i = j ; \boldsymbol{\theta}^{(t)})}{p(x_i; \boldsymbol{\theta}^{(t)})} \\
&= \frac{p(x_i, z_i = j ; \boldsymbol{\theta}^{(t)})}{\sum_{l = 1}^{k} p(x_i, z_i = l; \boldsymbol{\theta}^{(t)})} \\
&= \frac{f\left(x_i ; \mu_j^{(t)}, \Sigma_j^{(t)}\right) \cdot \phi_{j}^{(t)}}{\sum_{l = 1}^{k} f\left(x_i ; \mu_l^{(t)}, \Sigma_l^{(t)}\right) \cdot \phi_{l}^{(t)}}
\end{aligned}</script><p>For simplicity, let’s denote it by <script type="math/tex">p_{ji}^{(t)}</script></p>
<h2 id="M-step"><a href="#M-step" class="headerlink" title="M-step"></a>M-step</h2><p>We need to maximize, with respect to our parameters <script type="math/tex">\boldsymbol{\theta}^{(t)}</script>, the quantity</p>
<script type="math/tex; mode=display">
\begin{aligned}
Q(\boldsymbol{\theta} \mid \boldsymbol{\theta}^{(t)}) &= \sum_{i=1}^{n}\sum_{j=1}^{k} p_{ji}^{(t)} \log \frac{1}{(2 \pi)^{d / 2}\left|\Sigma_{j}\right|^{1 / 2}} \exp \left(-\frac{1}{2}\left(x_i-\mu_{j}\right)^{T} \Sigma_{j}^{-1}\left(x_i-\mu_{j}\right)\right) \cdot \phi_{j} \\
&= \sum_{i=1}^{n}\sum_{j=1}^{k} p_{ji}^{(t)} \left[\log \phi_j - \frac{1}{2} \log \left|\Sigma_{j}\right| - \frac{1}{2}(x_i-\mu_j)^T \Sigma_{j}^{-1}(x_i - \mu_j) - \frac{d}{2} \log(2\pi) \right]
\end{aligned}</script><ul>
<li><p>Update <script type="math/tex">\phi_j</script>:<br>Grouping together only the terms that depend on <script type="math/tex">\phi_j</script>, we find that we need to maximize</p>
<script type="math/tex; mode=display">
\sum_{i=1}^{n}\sum_{j=1}^{k} p_{ji}^{(t)} \log \phi_j</script><p>with subject to</p>
<script type="math/tex; mode=display">
\sum_{j=1}^{k} \phi_j = 1</script><p>So we construct the Lagrangian</p>
<script type="math/tex; mode=display">
\mathcal{L}(\phi) = \sum_{i=1}^{n}\sum_{j=1}^{k} p_{ji}^{(t)} \log \phi_j + \lambda \left( \sum_{j=1}^{k} \phi_j - 1 \right),</script><p>where <script type="math/tex">\lambda</script> is the Lagrange multiplier. Taking derivative, we find</p>
<script type="math/tex; mode=display">
\frac{\partial}{\partial \phi_{j}} \mathcal{L}(\phi)=\sum_{i=1}^{n} \frac{p_{ji}^{(t)}}{\phi_{j}}+\lambda</script><p>Setting this to zero and solving, we get</p>
<script type="math/tex; mode=display">
\phi_{j}=\frac{\sum_{i=1}^{n} p_{ji}^{(t)}}{-\lambda}</script><p>Using the constraint that <script type="math/tex">\sum_{j=1}^{k} \phi_j = 1</script> and knowing the fact that <script type="math/tex">\sum_{j=1}^{k} p_{ji}^{(t)} = 1</script> (probabilities sum to 1), we easily find:</p>
<script type="math/tex; mode=display">
-\lambda=\sum_{i=1}^{n} \sum_{j=1}^{k} p_{ji}^{(t)} = \sum_{i=1}^{n} 1= n</script><p>We therefore have updates for the parameters <script type="math/tex">\phi_j</script>:</p>
<script type="math/tex; mode=display">
\phi_{j} :=\frac{1}{n} \sum_{i=1}^{n} p_{ji}^{(t)}</script></li>
<li><p>Update <script type="math/tex">\mu_j</script></p>
<script type="math/tex; mode=display">
\begin{aligned}
\frac{\partial}{\partial \mu_{j}} Q(\boldsymbol{\theta} \mid \boldsymbol{\theta}^{(t)}) &= \frac{\partial}{\partial \mu_{j}} \sum_{i=1}^{n} -\frac{1}{2} p_{ji}^{(t)} (x_i-\mu_j)^T \Sigma_{j}^{-1}(x_i - \mu_j) \\
&= \frac{1}{2} \sum_{i=1}^{n} p_{ji}^{(t)} \dfrac{\partial}{\partial \mu_{j}} \left( 2 \mu_j^T\Sigma_j^{-1}x_i - \mu_j^T\Sigma_j^{-1}\mu_j \right) \\
&= \sum_{i=1}^{n} p_{ji}^{(t)} \left( \Sigma_j^{-1} x_i - \Sigma_j^{-1}\mu_j \right)
\end{aligned}</script><p>Setting this to zero and solving for <script type="math/tex">\mu_j</script> therefore yields the update rule</p>
<script type="math/tex; mode=display">
\mu_{j} :=\frac{\sum_{i=1}^{n} p_{ji}^{(t)} x_i}{\sum_{i=1}^{n} p_{ji}^{(t)}}</script></li>
<li><p>Update <script type="math/tex">\Sigma_j</script></p>
<script type="math/tex; mode=display">
\begin{aligned}
\frac{\partial}{\partial \Sigma_{j}} Q(\boldsymbol{\theta} \mid \boldsymbol{\theta}^{(t)}) &= \frac{\partial}{\partial \Sigma_{j}} \sum_{i=1}^{n} -\frac{1}{2} p_{ji}^{(t)} \left[ \log\left|\Sigma_{j}\right| + (x_i-\mu_j)^T \Sigma_{j}^{-1}(x_i - \mu_j)\right] \\
&= -\frac{1}{2} \sum_{i=1}^{n} p_{ji}^{(t)} \dfrac{\partial}{\partial \mu_{j}} \left[ \log\left|\Sigma_{j}\right| + (x_i-\mu_j)^T \Sigma_{j}^{-1}(x_i - \mu_j)\right] \\
&= -\frac{1}{2} \sum_{i=1}^{n} p_{ji}^{(t)} \left( \Sigma_{j}^{-1} - (x_i-\mu_j)(x_i - \mu_j)^T \Sigma_{j}^{-2} \right) \\
\end{aligned}</script><p>Setting this to zero and solving for <script type="math/tex">\Sigma_j</script> therefore yields the update rule</p>
<script type="math/tex; mode=display">
\Sigma_{j} :=\frac{\sum_{i=1}^{n} p_{ji}^{(t)} (x_i-\mu_j)(x_i - \mu_j)^T}{\sum_{i=1}^{n} p_{ji}^{(t)}}</script></li>
</ul>
<blockquote>
<p>If you are not familiar with the matrix / vector derivative calculus, you may refer to this <a href="./matrix.pdf">cheat sheet</a>.</p>
</blockquote>
<h2 id="More-about-GMM"><a href="#More-about-GMM" class="headerlink" title="More about GMM"></a>More about GMM</h2><p>Compared to K-Means which uses hard assignment, GMM uses soft assignment which a good way to represent uncertainty. But GMM is limited in its number of features since it requires storing a covariance matrix which has size quadratic in the number of features. Even when the number of features does not exceed this limit, this algorithm may perform poorly on high-dimensional data.<br>This is due to high-dimensional data:</p>
<ul>
<li>making it difficult to cluster at all (based on statistical/theoretical arguments) </li>
<li>numerical issues with Gaussian distributions</li>
</ul>

      
    </div>

    
      


    

    
    
    

    

    
      
    
    

    
      <div>
        




  



<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:  </strong>Hao Ren</li>
  <li class="post-copyright-link">
    <strong>Post link: </strong>
    
    <a href="http://invkrh.me/2019/05/14/expectation-maximization-explained/" title="Expectation-Maximization Algorithm Explained">http://invkrh.me/2019/05/14/expectation-maximization-explained/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.</li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Maths/" rel="tag"># Maths</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/05/14/wu-shui-cong-you-ji/" rel="next" title="无水葱油鸡">
                <i class="fa fa-chevron-left"></i> 无水葱油鸡
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/uploads/avatar.jpeg" alt="Hao Ren">
            
              <p class="site-author-name" itemprop="name">Hao Ren</p>
              <div class="site-description motion-element" itemprop="description">Machine Learning Engineer @ Criteo</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">5</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/invkrh" title="GitHub &rarr; https://github.com/invkrh" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://twitter.com/invkrh" title="Twitter &rarr; https://twitter.com/invkrh" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:invkrh@gmail.com" title="E-Mail &rarr; mailto:invkrh@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          
             <div class="cc-license motion-element" itemprop="license">
              
              
                
              
              
              
              <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
             </div>
          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Description"><span class="nav-text">Description</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Proof-of-correctness"><span class="nav-text">Proof of correctness</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Gaussian-Mixture-Model-GMM"><span class="nav-text">Gaussian Mixture Model (GMM)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Settings"><span class="nav-text">Settings</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#E-step"><span class="nav-text">E-step</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#M-step"><span class="nav-text">M-step</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#More-about-GMM"><span class="nav-text">More about GMM</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hao Ren</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.0"></script>

  <script src="/js/motion.js?v=7.1.0"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.1.0"></script>




  
  <script src="/js/scrollspy.js?v=7.1.0"></script>
<script src="/js/post-details.js?v=7.1.0"></script>



  


  <script src="/js/next-boot.js?v=7.1.0"></script>


  
  <script src="/js/js.cookie.js?v=7.1.0"></script>
  <script src="/js/scroll-cookie.js?v=7.1.0"></script>


  

  

  
  

<script src="//cdn.jsdelivr.net/npm/leancloud-storage@3/dist/av-min.js"></script>



<script src="//unpkg.com/valine/dist/Valine.min.js"></script>

<script>
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail';
  guest = guest.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: 'b0099Q4UewRf4nzkmN8I6zel-9Nh9j0Va',
    appKey: 'rCvpPdqxlekB0SeNTll2QOuW',
    placeholder: 'void',
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: false,
    lang: 'en' || 'zh-cn'
  });
</script>




  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-auth.js"></script>
  <script>
    (function () {
      function getCount(docRef) {
        return docRef.get().then(function (doc) {
          if (!doc.exists) {
            return 0;
          } else {
            return doc.data().count;
          }
        });
      }

      // TODO: use distributed counter
      function increaseCount(docRef, firstViewOnly) {
        return function (prevCount) {
          if (firstViewOnly && window.localStorage) {
            // increase view count if the article is viewed for the first time
            // increase view count in case the doc is removed
            if (!window.localStorage.getItem('Expectation-Maximization Algorithm Explained') || prevCount == 0) {
              docRef.set({ count: prevCount + 1 })
              .then(function() {
                localStorage.setItem('Expectation-Maximization Algorithm Explained', true);
              })
              .catch(function(error) {
                console.error("Error writing document: ", error);
              });
            }
          } else {
            docRef.set({ count: prevCount + 1 });
          }
        }
      }

      function appendCount2PostMeta(el) {
        return function (count) {
          $(el)
            .append(
              $('<span>')
                .addClass('post-visitors-count')
                .append(
                  $('<span>')
                    .addClass('post-meta-divider')
                    .text('|'))
                .append(
                  $('<span>')
                    .addClass('post-meta-item-icon')
                    .append(
                      $('<i>')
                      .addClass('fa fa-eye')))
                .append(
                  $('<span>')
                  .text('Views ' + count)));
        }
      }

      function countRead() {
        // See: https://hexo.io/docs/helpers.html
        if (true) { //is article page
          var docRef = articles.doc('Expectation-Maximization Algorithm Explained')
          getCount(docRef)
            .then(increaseCount(docRef, true))
            .then(function() { return getCount(docRef) })
            .then(appendCount2PostMeta($('.post-meta'))); // only one post-meta class for post page
        } else if (false) { //is index page
          var titles = []; //array to titles

          

          var promises = titles.map(function (title) {
            return articles.doc(title);
          }).map(function (docRef) {
            return getCount(docRef);
          })

          Promise.all(promises).then(function (counts) {
            var metas = $('.post-meta'); // all the post-meta classes for current index page
            counts.forEach(function (val, idx) {
              appendCount2PostMeta(metas[idx])(val);
            })
          })
        }
      }

      var config = {
        apiKey: 'AIzaSyAnKKcq1jkgXEtYqusGtdL8fF7rLRh8LXo',
        authDomain: 'yorozuya-51151.firebaseapp.com',
        projectId: 'yorozuya-51151'
      };

      firebase.initializeApp(config);

      var db = firebase.firestore();

      var articles = db.collection('articles');

      firebase.auth().signInAnonymously().catch(function(error) {
        // Handle Errors here.
        var errorCode = error.code;
        var errorMessage = error.message;
        console.log(errorCode);
        console.log(errorMessage);
      });

      /*
      Only anonymous user of authorized domain sign in.
      Incease the counter for signed anonymous users.
      ===>
      Only request from authorized domain can increase counter.
      */

      firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
          // User is signed in.
          var isAnonymous = user.isAnonymous;
          var uid = user.uid;
          countRead();
        } else {
          // User is signed out.
          // ...
        }
      });
    })()
  </script>


  
  

  
  

  
    
      <script type="text/x-mathjax-config">
  

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });
  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') { next = next.nextSibling }
        if (next && next.nodeName.toLowerCase() === 'br') { next.parentNode.removeChild(next) }
      }
    });
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      document.getElementById(all[i].inputID + '-Frame').parentNode.className += ' has-jax';
    }
  });
</script>
<script src="//cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    
  


  

  

  

  

  

  

  

  

  

  

  

  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
  <script type="text/javascript" src="/js/prism.js"></script>
</body>
</html>
